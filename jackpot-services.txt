// services/chainlink.js
const axios = require('axios');
const crypto = require('crypto');

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
 * –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Chainlink VRF –∏–ª–∏ –¥—Ä—É–≥–∏–º —Å–µ—Ä–≤–∏—Å–æ–º
 * –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ–º–æ–≥–æ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —á–∏—Å–ª–∞
 * 
 * @param {number} min - –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
 * @param {number} max - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
 * @returns {Promise<number>} - –°–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ
 */
async function generateRandomTicket(min, max) {
  try {
    // –í –ø—Ä–æ–¥–∞–∫—à–Ω-–≤–µ—Ä—Å–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Chainlink VRF
    // –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏ –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    
    // –ü–æ–ª—É—á–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å random.org –∏–ª–∏ –ø–æ–¥–æ–±–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
    const response = await axios.get('https://www.random.org/integers/', {
      params: {
        num: 1,
        min: 1,
        max: 1000000,
        col: 1,
        base: 10,
        format: 'plain',
        rnd: 'new'
      }
    });
    
    const externalRandomNumber = parseInt(response.data.trim());
    
    // –î–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
    const timestamp = Date.now();
    
    // –°–æ–∑–¥–∞–µ–º —Ö–µ—à –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —á–∏—Å–ª–∞ –∏ –≤—Ä–µ–º–µ–Ω–∏
    const hash = crypto.createHash('sha256')
      .update(`${externalRandomNumber}-${timestamp}`)
      .digest('hex');
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø–µ—Ä–≤—ã–µ 8 —Å–∏–º–≤–æ–ª–æ–≤ —Ö–µ—à–∞ –≤ —á–∏—Å–ª–æ
    const hashNumber = parseInt(hash.slice(0, 8), 16);
    
    // –ü—Ä–∏–≤–æ–¥–∏–º –∫ –Ω—É–∂–Ω–æ–º—É –¥–∏–∞–ø–∞–∑–æ–Ω—É
    const range = max - min + 1;
    const scaledRandom = (hashNumber % range) + min;
    
    // –°–æ–∑–¥–∞–µ–º –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–π —Ö–µ—à –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    const verificationHash = crypto.createHash('sha256')
      .update(`${externalRandomNumber}-${timestamp}-${scaledRandom}`)
      .digest('hex');
    
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å verificationHash
    // –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–µ—Å—Ç–Ω–æ—Å—Ç–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
    
    return scaledRandom;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —á–∏—Å–ª–∞:', error);
    
    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞,
    // –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä (–¥–ª—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏)
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }
}

module.exports = {
  generateRandomTicket
};

// services/telegram.js
const { Telegram } = require('telegraf');

// –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const PAYMENT_TOKEN = process.env.TELEGRAM_PAYMENT_TOKEN;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç Telegram API
const telegram = new Telegram(TELEGRAM_BOT_TOKEN);

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø–æ–¥–ø–∏—Å–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª
 * 
 * @param {string} userId - Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @param {string} channelUsername - –ò–º—è –∫–∞–Ω–∞–ª–∞ –±–µ–∑ @
 * @returns {Promise<boolean>} - –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
 */
async function verifySubscription(userId, channelUsername) {
  try {
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Telegram API
    // –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true —Å 90% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é
    // –í –ø—Ä–æ–¥–∞–∫—à–Ω-–≤–µ—Ä—Å–∏–∏ —ç—Ç–æ—Ç –∫–æ–¥ –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
    
    // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫ API —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
    await new Promise(resolve => setTimeout(resolve, 500));
    
    return Math.random() < 0.9;
  } catch (error) {
    console.error(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId} –Ω–∞ –∫–∞–Ω–∞–ª ${channelUsername}:`, error);
    return false;
  }
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–¥–µ–ª–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–ø–æ—Å—Ç
 * 
 * @param {string} userId - Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @returns {Promise<boolean>} - –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
 */
async function verifyShare(userId) {
  try {
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Telegram API
    // –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true —Å 85% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é
    // –í –ø—Ä–æ–¥–∞–∫—à–Ω-–≤–µ—Ä—Å–∏–∏ —ç—Ç–æ—Ç –∫–æ–¥ –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
    
    // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫ API —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
    await new Promise(resolve => setTimeout(resolve, 700));
    
    return Math.random() < 0.85;
  } catch (error) {
    console.error(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–ø–æ—Å—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}:`, error);
    return false;
  }
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ Telegram
 * 
 * @param {string} paymentId - ID –ø–ª–∞—Ç–µ–∂–∞ –∏–∑ Telegram
 * @returns {Promise<boolean>} - –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
 */
async function verifyTelegramPayment(paymentId) {
  try {
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Telegram Payments API
    // –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true —Å 95% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é
    // –í –ø—Ä–æ–¥–∞–∫—à–Ω-–≤–µ—Ä—Å–∏–∏ —ç—Ç–æ—Ç –∫–æ–¥ –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
    
    // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫ API —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
    await new Promise(resolve => setTimeout(resolve, 800));
    
    return Math.random() < 0.95;
  } catch (error) {
    console.error(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–∞ ${paymentId}:`, error);
    return false;
  }
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ Telegram
 * 
 * @param {string} userId - Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @param {string} message - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
 * @returns {Promise<boolean>} - –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏
 */
async function sendNotification(userId, message) {
  try {
    // –í –ø—Ä–æ–¥–∞–∫—à–Ω-–≤–µ—Ä—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∞–ª—å–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
    await telegram.sendMessage(userId, message, { parse_mode: 'HTML' });
    return true;
  } catch (error) {
    console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${userId}:`, error);
    return false;
  }
}

module.exports = {
  verifySubscription,
  verifyShare,
  verifyTelegramPayment,
  sendNotification
};

// services/scheduler.js
const schedule = require('node-schedule');
const { Round, Jackpot, User, Transaction } = require('../models');
const { generateRandomTicket } = require('./chainlink');
const { sendNotification } = require('./telegram');

/**
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∂–µ–∫–ø–æ—Ç–æ–≤ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞—É–Ω–¥–æ–≤
 */
function initScheduler() {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—É–Ω–¥–æ–≤ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
  schedule.scheduleJob('*/10 * * * *', async () => {
    try {
      await checkTimeoutRounds();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–∞—É–Ω–¥–æ–≤:', error);
    }
  });
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –¥–∂–µ–∫–ø–æ—Ç–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:05
  schedule.scheduleJob('5 0 * * *', async () => {
    try {
      await checkWeeklyJackpot();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –¥–∂–µ–∫–ø–æ—Ç–∞:', error);
    }
  });
  
  console.log('–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞–Ω–∏–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞—É–Ω–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –æ–∂–∏–¥–∞–Ω–∏–∏ —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ
 */
async function checkTimeoutRounds() {
  console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤ —Ä–∞—É–Ω–¥–æ–≤...');
  
  // –ù–∞–π—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–∞—É–Ω–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã –±–æ–ª–µ–µ 10 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥
  // –∏ –∏–º–µ—é—Ç —Ö–æ—Ç—è –±—ã 2 —É—á–∞—Å—Ç–Ω–∏–∫–∞
  const timeoutThreshold = new Date(Date.now() - 10 * 60 * 1000); // 10 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥
  
  const timeoutRounds = await Round.find({
    status: 'active',
    startTime: { $lt: timeoutThreshold },
    'participants.1': { $exists: true } // –•–æ—Ç—è –±—ã 2 —É—á–∞—Å—Ç–Ω–∏–∫–∞
  });
  
  for (const round of timeoutRounds) {
    console.log(`–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞—É–Ω–¥–∞ #${round.roundNumber} –ø–æ —Ç–∞–π–º–∞—É—Ç—É`);
    
    // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è —Ä–∞—É–Ω–¥–∞
    await determineWinner(round);
  }
}

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –¥–∂–µ–∫–ø–æ—Ç
 */
async function checkWeeklyJackpot() {
  console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –¥–∂–µ–∫–ø–æ—Ç–∞...');
  
  // –ù–∞–π—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–∂–µ–∫–ø–æ—Ç—ã —Å –∏—Å—Ç–µ–∫—à–µ–π –¥–∞—Ç–æ–π –æ–∫–æ–Ω—á–∞–Ω–∏—è
  const endedJackpots = await Jackpot.find({
    status: 'active',
    endDate: { $lt: new Date() }
  });
  
  for (const jackpot of endedJackpots) {
    if (jackpot.participants.length > 0) {
      await determineJackpotWinner(jackpot);
    } else {
      // –ï—Å–ª–∏ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –ø—Ä–æ—Å—Ç–æ –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π
      jackpot.status = 'completed';
      await jackpot.save();
    }
    
    // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –¥–∂–µ–∫–ø–æ—Ç
    const newEndDate = new Date();
    newEndDate.setDate(newEndDate.getDate() + 7); // –°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è
    
    const newJackpot = new Jackpot({
      startDate: new Date(),
      endDate: newEndDate,
      status: 'active'
    });
    
    await newJackpot.save();
    console.log(`–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –¥–∂–µ–∫–ø–æ—Ç –¥–æ ${newEndDate}`);
  }
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª—è —Ä–∞—É–Ω–¥–∞
 * 
 * @param {Object} round - –û–±—ä–µ–∫—Ç —Ä–∞—É–Ω–¥–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
 * @returns {Promise<boolean>} - –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
 */
async function determineWinner(round) {
  try {
    console.log(`–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –¥–ª—è —Ä–∞—É–Ω–¥–∞ #${round.roundNumber}`);
    
    // –ü–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π –±–∏–ª–µ—Ç —á–µ—Ä–µ–∑ Chainlink VRF
    const winningTicket = await generateRandomTicket(1, round.totalTickets);
    
    // –ù–∞–π—Ç–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –ø–æ –≤—ã–∏–≥—Ä—ã—à–Ω–æ–º—É –±–∏–ª–µ—Ç—É
    let winnerId = null;
    let winningParticipant = null;
    
    for (const participant of round.participants) {
      if (winningTicket >= participant.ticketStart && winningTicket <= participant.ticketEnd) {
        winnerId = participant.user;
        winningParticipant = participant;
        break;
      }
    }
    
    if (!winnerId) {
      console.error(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –¥–ª—è —Ä–∞—É–Ω–¥–∞ #${round.roundNumber}`);
      return false;
    }
    
    // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤—ã–∏–≥—Ä—ã—à (–æ–±—â–∏–π –±–∞–Ω–∫ –º–∏–Ω—É—Å –∫–æ–º–∏—Å—Å–∏—è)
    const fee = (round.totalPot * round.feePercent) / 100;
    const prize = round.totalPot - fee;
    
    // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–∞—É–Ω–¥–∞
    round.status = 'completed';
    round.endTime = new Date();
    round.winner = {
      user: winnerId,
      ticket: winningTicket,
      prize
    };
    round.winningTicket = winningTicket;
    
    // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
    const winner = await User.findById(winnerId);
    winner.balance += prize;
    winner.totalWon += prize;
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –æ—Ç—á–∏—Å–ª–µ–Ω–∏–π
    if (winner.referrer) {
      const referrer = await User.findById(winner.referrer);
      if (referrer) {
        const referralBonus = (prize * 10) / 100; // 10% –æ—Ç –≤—ã–∏–≥—Ä—ã—à–∞
        referrer.balance += referralBonus;
        referrer.referralEarnings += referralBonus;
        
        // –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª–∞
        const referralTransaction = new Transaction({
          user: referrer._id,
          type: 'referral',
          amount: referralBonus,
          referral: winner._id,
          round: round._id,
          status: 'completed',
          note: `–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å –æ—Ç –≤—ã–∏–≥—Ä—ã—à–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${winner.username || winner.telegramId}`
        });
        await referralTransaction.save();
        
        // –£–≤–µ–¥–æ–º–∏—Ç—å —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
        await sendNotification(
          referrer.telegramId,
          `üéâ –í—ã –ø–æ–ª—É—á–∏–ª–∏ <b>${referralBonus}</b> Stars –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±–æ–Ω—É—Å–∞ –æ—Ç –≤—ã–∏–≥—Ä—ã—à–∞ –≤–∞—à–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞!`
        );
        
        await referrer.save();
      }
    }
    
    // –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤—ã–∏–≥—Ä—ã—à–∞
    const transaction = new Transaction({
      user: winnerId,
      type: 'win',
      amount: prize,
      round: round._id,
      status: 'completed',
      note: `–í—ã–∏–≥—Ä—ã—à ${prize} Stars –≤ —Ä–∞—É–Ω–¥–µ #${round.roundNumber}`
    });
    
    // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥
    const newRound = new Round({
      roundNumber: round.roundNumber + 1,
      status: 'active',
      maxParticipants: round.maxParticipants,
      minBet: round.minBet,
      feePercent: round.feePercent
    });
    
    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    await Promise.all([
      round.save(),
      winner.save(),
      transaction.save(),
      newRound.save()
    ]);
    
    // –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
    await sendNotification(
      winner.telegramId,
      `üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ <b>${prize}</b> Stars –≤ —Ä–∞—É–Ω–¥–µ #${round.roundNumber}!`
    );
    
    // –£–≤–µ–¥–æ–º–∏—Ç—å –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    for (const participant of round.participants) {
      if (participant.user.toString() !== winnerId.toString()) {
        const user = await User.findById(participant.user);
        if (user) {
          await sendNotification(
            user.telegramId,
            `‚ÑπÔ∏è –†–∞—É–Ω–¥ #${round.roundNumber} –∑–∞–≤–µ—Ä—à–µ–Ω. –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–º —Å—Ç–∞–ª ${winner.isAnonymous ? '–ê–Ω–æ–Ω–∏–º–Ω—ã–π –∏–≥—Ä–æ–∫' : (winner.username || '–ò–≥—Ä–æ–∫')} —Å –≤—ã–∏–≥—Ä—ã—à–µ–º ${prize} Stars.`
          );
        }
      }
    }
    
    console.log(`–†–∞—É–Ω–¥ #${round.roundNumber} —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω. –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winner.telegramId}, –≤—ã–∏–≥—Ä—ã—à: ${prize} Stars`);
    return true;
    
  } catch (error) {
    console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –¥–ª—è —Ä–∞—É–Ω–¥–∞ #${round.roundNumber}:`, error);
    return false;
  }
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –¥–∂–µ–∫–ø–æ—Ç–∞
 * 
 * @param {Object} jackpot - –û–±—ä–µ–∫—Ç –¥–∂–µ–∫–ø–æ—Ç–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
 * @returns {Promise<boolean>} - –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
 */
async function determineJackpotWinner(jackpot) {
  try {
    console.log(`–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –¥–ª—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –¥–∂–µ–∫–ø–æ—Ç–∞ #${jackpot._id}`);
    
    // –í—ã—á–∏—Å–ª–∏—Ç—å –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–ª–µ—Ç–æ–≤
    const totalTickets = jackpot.participants.reduce((sum, p) => sum + p.tickets, 0);
    
    if (totalTickets === 0) {
      console.log('–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –¥–∂–µ–∫–ø–æ—Ç–µ. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à.');
      jackpot.status = 'completed';
      await jackpot.save();
      return false;
    }
    
    // –ü–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π –±–∏–ª–µ—Ç
    const winningTicket = await generateRandomTicket(1, totalTickets);
    
    // –ù–∞–π—Ç–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
    let currentTicket = 0;
    let winner = null;
    
    for (const participant of jackpot.participants) {
      currentTicket += participant.tickets;
      if (winningTicket <= currentTicket) {
        winner = participant;
        break;
      }
    }
    
    if (!winner) {
      console.error(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –¥–ª—è –¥–∂–µ–∫–ø–æ—Ç–∞ #${jackpot._id}`);
      return false;
    }
    
    // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–∂–µ–∫–ø–æ—Ç–∞
    jackpot.status = 'completed';
    jackpot.winner = {
      user: winner.user,
      ticket: winningTicket,
      prize: jackpot.totalPot
    };
    jackpot.winningTicket = winningTicket;
    await jackpot.save();
    
    // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
    const winnerUser = await User.findById(winner.user);
    winnerUser.balance += jackpot.totalPot;
    winnerUser.totalWon += jackpot.totalPot;
    
    // –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    const transaction = new Transaction({
      user: winner.user,
      type: 'win',
      amount: jackpot.totalPot,
      jackpot: jackpot._id,
      status: 'completed',
      note: `–í—ã–∏–≥—Ä—ã—à ${jackpot.totalPot} Stars –≤ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–º –¥–∂–µ–∫–ø–æ—Ç–µ`
    });
    
    await Promise.all([
      winnerUser.save(),
      transaction.save()
    ]);
    
    // –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
    await sendNotification(
      winnerUser.telegramId,
      `üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ <b>${jackpot.totalPot}</b> Stars –≤ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–º –¥–∂–µ–∫–ø–æ—Ç–µ!`
    );
    
    console.log(`–î–∂–µ–∫–ø–æ—Ç #${jackpot._id} —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑—ã–≥—Ä–∞–Ω. –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winnerUser.telegramId}, –≤—ã–∏–≥—Ä—ã—à: ${jackpot.totalPot} Stars`);
    return true;
    
  } catch (error) {
    console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –¥–ª—è –¥–∂–µ–∫–ø–æ—Ç–∞ #${jackpot._id}:`, error);
    return false;
  }
}

module.exports = {
  initScheduler,
  checkTimeoutRounds,
  checkWeeklyJackpot,
  determineWinner,
  determineJackpotWinner
};

// services/notifications.js
const { User } = require('../models');
const { sendNotification } = require('./telegram');

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º–∞—Å—Å–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
 * 
 * @param {string} message - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
 * @param {Object} options - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏
 * @returns {Promise<Object>} - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
 */
async function sendMassNotification(message, options = {}) {
  const { filter = {}, dryRun = false } = options;
  
  try {
    // –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä—É
    const users = await User.find(filter).select('telegramId');
    
    console.log(`–û—Ç–ø—Ä–∞–≤–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ${users.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º`);
    
    if (dryRun) {
      return {
        success: true,
        usersCount: users.length,
        message: '–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º, —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã'
      };
    }
    
    let successCount = 0;
    let failureCount = 0;
    
    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –ø–∞–∫–µ—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Telegram
    for (let i = 0; i < users.length; i++) {
      try {
        const sent = await sendNotification(users[i].telegramId, message);
        
        if (sent) {
          successCount++;
        } else {
          failureCount++;
        }
        
        // –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        if (i % 20 === 0 && i > 0) {
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${users[i].telegramId}:`, error);
        failureCount++;
      }
    }
    
    return {
      success: true,
      totalUsers: users.length,
      successCount,
      failureCount
    };
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–∞—Å—Å–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
    return {
      success: false,
      error: error.message
    };
  }
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º —Ä–∞—É–Ω–¥–µ –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
 * 
 * @param {Object} round - –û–±—ä–µ–∫—Ç —Ä–∞—É–Ω–¥–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
 * @returns {Promise<boolean>} - –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏
 */
async function notifyAboutNewRound(round) {
  try {
    // –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
    const lastActiveThreshold = new Date(Date.now() - 24 * 60 * 60 * 1000);
    
    const activeUsers = await User.find({
      lastActive: { $gte: lastActiveThreshold }
    }).select('telegramId');
    
    const message = `üéÆ –ù–æ–≤—ã–π —Ä–∞—É–Ω–¥ #${round.roundNumber} –Ω–∞—á–∞–ª—Å—è! –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: ${round.minBet} Stars.`;
    
    for (let i = 0; i < activeUsers.length; i++) {
      try {
        await sendNotification(activeUsers[i].telegramId, message);
        
        // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏
        if (i % 20 === 0 && i > 0) {
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤–æ–º —Ä–∞—É–Ω–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${activeUsers[i].telegramId}:`, error);
      }
    }
    
    return true;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤–æ–º —Ä–∞—É–Ω–¥–µ:', error);
    return false;
  }
}

module.exports = {
  sendMassNotification,
  notifyAboutNewRound
};

// services/index.js
module.exports = {
  chainlink: require('./chainlink'),
  telegram: require('./telegram'),
  scheduler: require('./scheduler'),
  notifications: require('./notifications')
};